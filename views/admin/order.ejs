<%- include('../partials/admin/header') %>  
<style>
    .hidden {
  display: none;
}

</style>
<div class="container mx-auto p-4">

    <!-- Page Header -->
    <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-md mb-1">
        <h1 class="text-xl font-semibold">Order Management</h1>
        <button class="bg-yellow-500 hover:bg-yellow-600 text-black py-2 px-4 rounded-lg">
            Cancel/Return request
        </button>
    </div>

    <!-- Orders Table -->
    <div class="bg-white p-4 rounded-lg shadow-md">
        <table class="w-full table-auto border-collapse">
            <thead class="bg-gray-200">
                <tr>
                    <th class="px-4 py-2 text-left">Product</th>
                    <th class="px-4 py-2 text-left">Order ID</th>
                    <th class="px-4 py-2 text-left">Variant</th>
                    <th class="px-4 py-2 text-left">Payment Method</th>
                    <th class="px-4 py-2 text-left">Status</th>
                    <th class="px-4 py-2 text-left">Amount</th>
                </tr>
            </thead>
            <tbody>
              

                <!-- Loop through orders using EJS -->
                <% orders.forEach(order => { %>
                    <% order.items.forEach(item => { %>
                        <tr class="border-b">
                            <td class="px-4 py-2 flex items-center">
                                <img src="<%= item.productImage %>" alt="<%= item.productName %>" class="w-12 h-12 object-cover mr-4" />
                                <span><%= item.productName %></span>
                            </td>
                            <td class="px-4 py-2"><%= order.orderId %></td>
                            <td class="px-4 py-2"><%= item.size %> / <%= item.quantity %></td> 
                            <td class="px-4 py-2"><%= order.paymentMethod %></td>
                            <td class="px-4 py-2">
                              <%= item.status %>
                              <% if (item.status !== 'Delivered') { %>
                                  <!-- Edit Icon -->
                                  <i
                                      class="fa fa-edit text-blue-500 cursor-pointer ml-2"
                                      onclick="showStatusChange('<%= order._id %>', '<%= item.productId %>', '<%= item.size %>')"
                                  ></i>
                          
                                  <!-- Hidden form for status change -->
                                  <form id="status-form-<%= order._id %>-<%= item.productId %>" 
                                        action="/admin/update-status" 
                                        method="POST" 
                                        class="hidden mt-2">
                                      <input type="hidden" name="orderId" value="<%= order._id %>">
                                      <input type="hidden" name="productId" value="<%= item.productId %>">
                                      <input type="hidden" name="size" value="<%= item.size %>">
                                      <select name="status" class="p-1 border rounded">
                                          <% if (item.status === 'Pending') { %>
                                              <option value="Shipped">Shipped</option>
                                              <option value="out for delivery">Out for Delivery</option>
                                              <option value="Delivered">Delivered</option>
                                          <% } else if (item.status === 'Shipped') { %>
                                              <option value="out for delivery">Out for Delivery</option>
                                              <option value="Delivered">Delivered</option>
                                          <% } else if (item.status === 'out for delivery') { %>
                                              <option value="Delivered">Delivered</option>
                                          <% } %>
                                      </select>
                                      <button type="submit" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded">Update</button>
                                  </form>
                              <% } else { %>
                                  <!-- Status can't be changed -->
                              <% } %>
                          </td>
                          
                          
                            
                            <td class="px-4 py-2"><%= item.price %></td>
                        </tr>
                    <% }); %>
                <% }); %>
            </tbody>
        </table>
    </div>

    <!-- Pagination Section -->
    <div class="flex items-center justify-center mt-4 space-x-2">
        <!-- Previous Button -->
        <a 
          href="?page=<%= currentPage > 1 ? currentPage - 1 : 1 %>" 
          class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300 <%= currentPage === 1 ? 'cursor-not-allowed opacity-50' : '' %>">
          &laquo;
        </a>
      
        <!-- Page Numbers -->
        <% for (let i = 1; i <= totalPages; i++) { %>
          <a 
            href="?page=<%= i %>" 
            class="px-4 py-2 rounded <%= currentPage === i ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
            <%= i %>
          </a>
        <% } %>
      
        <!-- Next Button -->
        <a 
          href="?page=<%= currentPage < totalPages ? currentPage + 1 : totalPages %>" 
          class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300 <%= currentPage === totalPages ? 'cursor-not-allowed opacity-50' : '' %>">
          &raquo;
        </a>
      </div>
      
</div>
<script>
   function showStatusChange(orderId, productId, size) {
    const formId = `status-form-${orderId}-${productId}`;
    const form = document.getElementById(formId);
    
    console.log('Order ID:', orderId);
    console.log('Product ID:', productId);
    console.log('Size:', size);
    console.log('Form:', form);
    
    if (form) {
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden'); // Show the form
        } else {
            form.classList.add('hidden'); // Hide the form
        }
    }
}
</script>

<%- include('../partials/admin/footer') %> 
